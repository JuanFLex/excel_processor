<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-font-smoothing: antialiased; }
        tbody tr:hover { background-color: rgba(249, 250, 251, 0.6); }
        .border { transition: border-color 0.2s ease; }
    </style>
</head>
<body>
    <div class="min-h-screen bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
            <!-- Header -->
            <div class="mb-12">
                <%= link_to "← Back", file_uploads_path, class: "text-sm text-gray-600 hover:text-gray-900 mb-6 inline-block" %>
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl font-medium text-gray-900"><%= @processed_file.original_filename %></h1>
                        <p class="text-sm text-gray-500 mt-1">ID <%= @processed_file.id %></p>
                    </div>
                    <div class="flex gap-3">
                        <% if @processed_file.completed? && @processed_file.result_file_path.present? %>
                            <%= link_to "Download Result", download_file_upload_path(@processed_file),
                                 class: "px-5 py-2.5 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-md transition-colors" %>
                            <%= link_to "Remap & Reprocess", remap_file_upload_path(@processed_file),
                                 class: "px-5 py-2.5 border border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-900 text-sm font-medium rounded-md transition-colors" %>
                        <% end %>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <% status_color = {'completed' => 'green', 'processing' => 'blue', 'queued' => 'amber', 'failed' => 'red'}[@processed_file.status] || 'gray' %>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 p-6 bg-gray-50 rounded-lg mb-12">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-500 mb-1">Status</p>
                    <p class="text-sm font-medium text-<%= status_color %>-600"><%= @processed_file.status.titleize %></p>
                </div>
                <% [['Uploaded', @processed_file.created_at],
                     ['Completed', @processed_file.processed_at],
                     ['Total Items', @processed_file.processed_items.count]].each do |label, value| %>
                    <div>
                        <p class="text-xs uppercase tracking-wider text-gray-500 mb-1"><%= label %></p>
                        <p class="text-sm font-medium text-gray-900">
                            <%= value.is_a?(Time) ? value.strftime("%b %d · %H:%M") : (value || '—') %>
                        </p>
                    </div>
                <% end %>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Column Mapping -->
                <section>
                    <h2 class="text-sm font-medium text-gray-900 uppercase tracking-wider mb-6">Column Mapping</h2>
                    <% if @processed_file.column_mapping&.any? %>
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <% ['Target Field', 'Source Column', 'Status'].each_with_index do |header, i| %>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider <%= 'text-right' if i == 2 %>">
                                                <%= header %>
                                            </th>
                                        <% end %>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <% @processed_file.column_mapping.each do |target, source| %>
                                        <tr>
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900"><%= target %></td>
                                            <td class="px-6 py-4 text-sm text-gray-600"><%= source || '—' %></td>
                                            <td class="px-6 py-4 text-right text-xs font-medium <%= source ? 'text-green-600' : 'text-red-600' %>">
                                                <%= source ? 'Mapped' : 'Missing' %>
                                            </td>
                                        </tr>
                                    <% end %>
                                </tbody>
                            </table>
                        </div>
                    <% else %>
                        <div class="bg-gray-50 rounded-lg p-12 text-center">
                            <p class="text-sm text-gray-500">No mapping data available</p>
                        </div>
                    <% end %>
                </section>

                <!-- Processing Summary -->
                <section>
                    <h2 class="text-sm font-medium text-gray-900 uppercase tracking-wider mb-6">Processing Summary</h2>
                    <% if @items_sample&.any? %>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                            <div class="p-6 bg-white border border-green-200 rounded-lg">
                                <p class="text-2xl font-semibold text-green-700">
                                <%= number_with_delimiter(@processed_file.processed_items.where(scope: 'In scope').count) %>
                                </p>
                                <p class="text-xs uppercase tracking-wider text-green-600 mt-1">In Scope</p>
                            </div>
                            <div class="p-6 bg-white border border-red-200 rounded-lg">
                                <p class="text-2xl font-semibold text-red-700">
                                <%= number_with_delimiter(@processed_file.processed_items.where(scope: 'Out of scope').count) %>
                                </p>
                                <p class="text-xs uppercase tracking-wider text-red-600 mt-1">Out of Scope</p>
                            </div>
                            <div class="p-6 bg-white border border-blue-200 rounded-lg">
                                <p class="text-2xl font-semibold text-blue-700">
                                $<%= number_to_human(@total_ear, precision: 1, format: '%n%u') %>
                                </p>
                                <p class="text-xs uppercase tracking-wider text-blue-600 mt-1">Total EAR</p>
                            </div>
                            <div class="p-6 bg-white border border-orange-200 rounded-lg">
                                <p class="text-2xl font-semibold text-orange-700">
                                <%= number_with_delimiter(@exceeds_threshold_count) %>
                                </p>
                                <p class="text-xs uppercase tracking-wider text-orange-600 mt-1">Exceeds Threshold</p>
                            </div>
                            <div class="p-6 bg-white border border-gray-200 rounded-lg">
                                <p class="text-2xl font-semibold text-gray-700">
                                <%= number_with_delimiter(@below_threshold_count) %>
                                </p>
                                <p class="text-xs uppercase tracking-wider text-gray-600 mt-1">Below Threshold</p>
                            </div>
                            </div>

                        <h3 class="text-xs font-medium text-gray-700 uppercase tracking-wider mb-3">
                            Sample Items <span class="text-gray-400 font-normal">(showing <%= [@items_sample.size, 10].min %> of <%= number_with_delimiter(@processed_file.processed_items.count) %>)</span>
                        </h3>
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <% ['Item', 'Description', 'Commodity', 'Scope'].each_with_index do |header, i| %>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider <%= 'text-center' if i == 3 %>">
                                                <%= header %>
                                            </th>
                                        <% end %>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <% @items_sample.first(10).each do |item| %>
                                        <tr>
                                            <td class="px-4 py-3 text-sm text-gray-900"><%= truncate(item.item, length: 25) %></td>
                                            <td class="px-4 py-3 text-sm text-gray-600"><%= truncate(item.description, length: 40) %></td>
                                            <td class="px-4 py-3 text-sm text-gray-600"><%= item.commodity || '—' %></td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex px-2 py-1 text-xs font-medium rounded <%= item.scope == 'In scope' ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50' %>">
                                                    <%= item.scope %>
                                                </span>
                                            </td>
                                        </tr>
                                    <% end %>
                                </tbody>
                            </table>
                        </div>
                    <% else %>
                        <div class="bg-gray-50 rounded-lg p-12 text-center">
                            <p class="text-sm text-gray-500"><%= @processed_file.processing? ? 'Processing in progress' : 'No items processed yet' %></p>
                        </div>
                    <% end %>
                </section>
            </div>

            <% if @processed_file.error_message.present? %>
                <div class="mt-8 p-6 bg-red-50 border border-red-200 rounded-lg">
                    <h3 class="text-sm font-medium text-red-900 mb-2">Processing Error</h3>
                    <p class="text-sm text-red-700"><%= @processed_file.error_message %></p>
                </div>
            <% end %>
        </div>
    </div>

    <!-- Auto-reload for processing files -->
    <% if @processed_file.status == 'queued' || @processed_file.processing? %>
        <script>
            // Auto-refresh every 5 seconds for processing status
            setTimeout(function() {
                window.location.reload();
            }, 5000);
        </script>
    <% end %>
</body>
</html>